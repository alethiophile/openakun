{% extends "base.html" %}
{% block title %}{{ chapter.story.title }}{% endblock %}
{% block head %}
    {{ super() }}
    {% if chapter.story.author == user %}
        <link href="https://cdn.quilljs.com/1.3.2/quill.snow.css" rel="stylesheet">
        <script src="https://cdn.quilljs.com/1.3.2/quill.js"></script>
    {% endif %}
    <script src="{{ url_for('static', filename='jinja.js') }}" integrity="sha384-cm3HUQ6bTRjf6UEdiBbA4EVE+5HHakERCDN3cwzBZbJxfi8ZdCNH6OGNEiJKv36F" crossorigin="anonymous"></script>
    <style>
     #quill-editor {
         min-height: 5rem;
         overflow-y: auto;
     }
     .chat {
         position: absolute;
         width: 95%;
         bottom: 0;
         height: 100%;
     }
     #chat-messages {
         overflow-y: auto;
         width: 100%;
         flex: auto;
         margin-bottom: 20px;
     }
     #chat-type {
         width: 15%;
         display: block;
         box-sizing: padding-box;
         overflow: hidden;
         flex: auto;
     }
     #chat-send {
         flex: none;
     }
     .chat-controls {
         width: 100%;
         display: flex;
         padding-right: 10px;
     }
     .chatmsg {
         padding: 5px;
     }
     .chatmsg:hover {
         background-color: #ccc;
     }
     .chat_head {
         display: flex;
     }
     .chat_sender {
         font-size: small;
         font-weight: bold;
         margin-right: .5rem;
     }
     .chat_date {
         font-size: small;
         color: #888;
     }
     #chapter_section {
         display: flex;
     }
     #chaptertitle_inp {
         visibility: hidden;
         flex: auto;
     }
     .post {
         margin-bottom: 1rem;
     }
     .post_date {
         margin-top: -.5rem;
         text-align: right;
         font-size: small;
         color: #888;
     }
    </style>
    <script id="render_post" type="text/x-tmpl-jinja">
     {{- include_raw('render_post.html') -}}
    </script>
    <script id="render_chatmsg" type="text/x-tmpl-jinja">
     {{- include_raw('render_chatmsg.html') -}}
    </script>
    <script>
     var chapter_id = {{ chapter.id }};
     var channel_id = {{ chapter.story.channel_id }};
     var post_url = '{{ url_for('new_post') }}';
     var username = '{{ 'anon' if user.is_anonymous else user.name }}';
     var csrf_token = '{{ session['_csrf_token']}}';
     var anon_username = 'anon';
     $(function () {
         $('.rerender-date').each(function () {
             var m = moment($(this).data('dateval'));
             var rd = m.format("MMM Do, YYYY h:mm A");
             $(this).html(rd);
         });
         if (typeof Quill !== 'undefined') {
             var quill = new Quill('#quill-editor', {
                 theme: 'snow',
             });
             $('#post-button').click(function () {
                 var post_html = quill.root.innerHTML;
                 console.log('doing post');
                 $.ajax(post_url, {
                     method: 'POST',
                     data: { chapter_id: chapter_id, post_text: post_html,
                             _csrf_token: csrf_token },
                     success: function () {
                         document.location.href = document.location.href;
                     },
                     error: function (jqxhr, status, errorThrown) {
                         var errstr = "Error: " + status + " " + errorThrown;
                         console.log(errstr);
                         alert(errstr);
                     },
                 });
             });
         }

         var socket = io();
         var msgs_recvd = new Set();
         socket.on('connect', function () {
             console.log('joining room');
             socket.emit('join', { channel: '' + channel_id }, function (res) {
                 console.log("join result", res)
                 socket.emit('backlog', { channel: '' + channel_id });
             });
         });
         socket.on('chat_msg', function (data) {
             console.log('got chat message', data);
             data.rendered_date = moment(data.date).format("MMM Do, YYYY h:mm A");
             if (!msgs_recvd.has(data.id_token)) {
                 add_chat_msg(data);
                 msgs_recvd.add(data.id_token);
             }
         });
         socket.on('disconnect', function (reason) {
             console.log('disconnected', reason);
             socket.connect();
         });
         socket.on('connect_error', function (error) {
             console.log('connection error');
             setTimeout(function () {
                 console.log('trying reconnect');
                 socket.connect();
             }, 1000);
         });
         function socket_err(error) {
             console.log('error', error);
         }
         socket.on('error', socket_err);
         socket.on('connect_timeout', socket_err);

         /* basically compatible with Python's secrets.token_urlsafe */
         function make_token(bytes=32) {
             var arr = new Uint8Array(bytes);
             window.crypto.getRandomValues(arr);
             var b64 = btoa(String.fromCharCode.apply(null, arr));
             var tok = b64.replace(/\+/g, '_').replace(/\//g, '-').replace(/=/g, '');
             return tok;
         }

         var chat_tmpl = jinja.compile($('#render_chatmsg').html(), {runtime: true});
         /* Adds a message to the chatbox, rendering it. Called
            for every message that comes in over the wire. */
         function add_chat_msg (msg) {
             var $cm = $('#chat-messages');
             var scrollBottomVal = $cm[0].scrollHeight - $cm.height();
             if (msg.is_anon) {
                 msg.username = anon_username;
             }
             var $d = $(chat_tmpl.render({ c: msg}));
             $('#chat-messages').append($d);
             var msgHeight = $d.height();
             if (scrollBottomVal - $cm[0].scrollTop < msgHeight) {
                 $cm.scrollTop($cm.height());
             }
         }
         /* Send a chat message. Takes a string message, arranges
            for it to be sent. Currently a testing implementation
            that just feeds it back to the display function. */
         function chat_send (msg) {
             var mo = { channel: '' + channel_id, msg: msg, id_token: make_token() }
             socket.emit('chat_msg', mo);
         }
         function chat_trigger_send () {
             var $ct = $('#chat-type');
             chat_send($ct.val());
             $ct.val('');
             $ct.attr('rows', $ct.data('min-rows'));
         }
         /* copied from https://codepen.io/vsync/pen/frudD, with modifications */
         $('#chat-type').one('focus', function () {
             var savedValue = this.value;
             this.value = '';
             this.baseScrollHeight = this.scrollHeight;
             this.value = savedValue;
         }).on('input', function () {
             var minRows = this.getAttribute('data-min-rows')|0, rows;
             this.rows = minRows;
             rows = Math.ceil((this.scrollHeight - this.baseScrollHeight) / 21);
             var $cm = $('#chat-messages');
             var scrollFrac = $cm[0].scrollTop / ($cm[0].scrollHeight - $cm.height());
             this.rows = minRows + rows;
             $cm[0].scrollTop = scrollFrac * ($cm[0].scrollHeight - $cm.height());
         });
         $('#chat-type').keydown(function (ev) {
             if (ev.which == 13 && !ev.shiftKey) {
                 chat_trigger_send();
                 return false;
             }
             return true;
         });
         $('#chat-send').click(function () {
             chat_trigger_send();
         });
         $('#newchapter').change(function () {
             if ($(this).is(':checked')) {
                 $('#chaptertitle_inp').css('visibility', 'visible');
             } else {
                 $('#chaptertitle_inp').css('visibility', 'hidden');
             }
         });
     });
    </script>
{% endblock %}
{% block content %}
    <h2>{{ chapter.story.title }}</h2>
    {% if chapter == chapter.story.chapters[0] %}
        <div class="description">
            {{ chapter.story.description | safe }}
        </div>
    {% endif %}
    {% for p in chapter.posts %}
        {% do prepare_post(p) %}
        {% include 'render_post.html' %}
    {% endfor %}
    {% if chapter.story.author == user %}
        <h5 class="mb-3">Make a new post</h5>
        <div class="form-inline form-group" id="chapter_section">
            <input class="form-check-input" type="checkbox" value="1" id="newchapter">
            <label class="form-check-label mr-5">Begin a new chapter</label>
            <input class="form-control" type="text" id="chaptertitle_inp" placeholder="Title">
        </div>
        <div id="quill-editor">
        </div>
        <button class="btn mt-2" id="post-button">Post</button>
    {% endif %}
{% endblock %}
{% block sidebar %}
    <div id="chat-messages">
    </div>
    <div class="chat-controls form-inline mb-2">
        <textarea rows="1" data-min-rows="1" id="chat-type" class="autoExpand form-control-sm mr-1" placeholder="Chat"></textarea>
        <button id="chat-send" class="btn btn-sm">Send</button>
    </div>
{% endblock %}
