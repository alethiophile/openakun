{% extends "base.html" %}
{% block title %}{{ chapter.story.title }}{% endblock %}
{% block head %}
    {{ super() }}
    {% if chapter.story.author == current_user %}
        <link href="https://cdn.quilljs.com/1.3.2/quill.snow.css" rel="stylesheet">
        <script nonce="{{ get_script_nonce() }}" src="https://cdn.quilljs.com/1.3.2/quill.js"></script>
        <script nonce="{{ get_script_nonce() }}">
         var is_author = true;
        </script>
    {% endif %}
    <script nonce="{{ get_script_nonce() }}" src="{{ url_for('static', filename='nunjucks.min.js') }}" integrity="sha384-XkUA224v0wKRJiWS8sAC+XghpZFy4Vm/wfOWV3sto658OqhxOtJaSpR8AD9cPPjk" crossorigin="anonymous"></script>
    <script nonce="{{ get_script_nonce() }}" defer src="https://cdn.jsdelivr.net/npm/@alpinejs/morph@3.x.x/dist/cdn.min.js" integrity="sha384-JbZV0T/jovQmjdA5UHCXZHWj4y8l1f9BttjdK58Bwam7z2qiXBPm3uEW/H+3Wb3i" crossorigin="anonymous"></script>
    <script nonce="{{ get_script_nonce() }}" defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.3/dist/cdn.min.js" integrity="sha384-mPO6U7t0sNHfI1UIWNf5U6FDzprqWgAMKfOGW86JVGCKoU/7HPdy6DwBaWOsi4eV" crossorigin="anonymous"></script>
    <script nonce="{{ get_script_nonce() }}" src="{{ url_for('static', filename='util.js') }}"></script>
    <script nonce="{{ get_script_nonce() }}" src="{{ url_for('static', filename='votes.js') }}"></script>
    {% if get_dark_mode() %}
      <link rel="stylesheet" href="{{ url_for('static', filename='dark-mode.css') }}">
    {% else %}
      <link rel="stylesheet" href="{{ url_for('static', filename='light-mode.css') }}">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='chapter.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='votes.css') }}">
    <script id="render_post" type="text/x-tmpl-jinja">
     {{- include_raw('render_post.html') | safe -}}
    </script>
    <script id="render_chatmsg" type="text/x-tmpl-jinja">
     {{- include_raw('render_chatmsg.html') | safe -}}
    </script>
    <script nonce="{{ get_script_nonce() }}">
     var chapter_id = {{ chapter.id }};
     var channel_id = '{{ chapter.story.channel_id }}';
     var post_url = '{{ url_for('questing.new_post') }}';
     var csrf_token = '{{ session['_csrf_token'] }}';
     var anon_username = 'anon';
    </script>
    <script nonce="{{ get_script_nonce() }}" src="{{ url_for('static', filename='chapter.js') }}"></script>
{% endblock %}
{% block inside_menubar %}
    <div class="navbar-nav">
        <div class="dropdown">
            <a class="btn nav-link dropdown-toggle" id="chaptermenu-link" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Story</a>
            <div class="dropdown-menu" aria-labelledby="chaptermenu-link">
                {% if chapter.story.chapters|length > 1 %}
                    <span class="dropdown-header">Contents</span>
                    {% for i in chapter.story.chapters %}
                        <a class="dropdown-item" href="{{ url_for('questing.view_chapter', story_id=chapter.story.id, chapter_id=i.id) }}">{{ i.title }}</a>
                    {% endfor %}
                {% endif %}
                <span class="dropdown-header">Story actions</span>
                <div id="story_actions"><div class="dropdown-item">1</div><div class="dropdown-item">2</div></div>
            </div>
        </div>
    </div>
{% endblock %}
{% block content %}
  <h1 class="story-title">{{ chapter.story.title }}</h1>
  <div class="story-author">
    <a href="{{ url_for('questing.user_profile', user_id=chapter.story.author.id) }}">{{ chapter.story.author.name }}</a>
  </div>
  {% if chapter == chapter.story.chapters[0] %}
    <div class="description">
      {{ chapter.story.description | safe }}
    </div>
  {% endif %}
  <div id="story-content">
    {% for p in chapter.posts %}
      {% do prepare_post(p) %}
      {% include 'render_post.html' %}
    {% endfor %}
  </div>
  {% if chapter != chapter.story.chapters[-1] %}
    {% set next_chapter = chapter.story.chapters[chapter.story.chapters.index(chapter)+1] %}
    <a class="nextchapter_link" href="{{ url_for('questing.view_chapter', story_id=chapter.story.id, chapter_id=next_chapter.id) }}">Next: {{ next_chapter.title }}</a>
  {% endif %}
  {% if chapter.story.author == current_user and chapter == chapter.story.chapters[-1] %}
    <h5 class="mb-3">Make a new post</h5>
    <div class="form-inline form-group" id="chapter_section">
      <input class="form-check-input" type="checkbox" value="1" id="newchapter">
      <label class="form-check-label mr-5">Begin a new chapter</label>
      <input class="form-control" type="text" id="chaptertitle_inp" placeholder="Title">
    </div>
    <label class="radio-inline"><input type="radio" name="post_type" value="text" checked="checked"> Text post</label>
    <label class="radio-inline"><input type="radio" name="post_type" value="vote"> Vote</label>
    <label class="radio-inline"><input type="radio" name="post_type" value="writein"> Write-in</label>
    <div id="text-editor">
      <div id="quill-editor">
      </div>
    </div>
    <div id="vote-editor" style="display:none">
    </div>
    <button class="btn mt-2" id="post-button">Post</button>
  {% endif %}
{% endblock %}
{% block sidebar %}
    <div id="chat-messages">
    </div>
    <div class="chat-controls form-inline mb-2">
        <textarea rows="1" data-min-rows="1" id="chat-type" class="autoExpand form-control-sm mr-1" placeholder="Chat"></textarea>
        <button id="chat-send" class="btn btn-sm">Send</button>
    </div>
{% endblock %}
