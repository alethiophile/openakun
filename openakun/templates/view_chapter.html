{% extends "base.html" %}
{% block title %}{{ chapter.story.title }}{% endblock %}
{% block head %}
    {{ super() }}
    {% if chapter.story.author == user %}
        <link href="https://cdn.quilljs.com/1.3.2/quill.snow.css" rel="stylesheet">
        <script src="https://cdn.quilljs.com/1.3.2/quill.js"></script>
        <style>
         #quill-editor {
           min-height: 5rem;
           overflow-y: auto;
         }
         .chat {
           position: absolute;
           width: 95%;
           bottom: 0;
         }
         #chat-type {
           width: 100%;
           resize: none;
           box-sizing: content-box;
         }
         /* .chat-controls {
            width: 100%
            } */
        </style>
        <script>
         var chapter_id = {{ chapter.id }};
         var post_url = '{{ url_for('new_post') }}';
         var username = '{{ user.name }}';
         $(function () {
             var quill = new Quill('#quill-editor', {
                 theme: 'snow',
             });
             $('#post-button').click(function () {
                 var post_html = quill.root.innerHTML;
                 console.log('doing post');
                 $.ajax(post_url, {
                     method: 'POST',
                     data: { chapter_id: chapter_id, post_text: post_html },
                     success: function () {
                         document.location.href = document.location.href;
                     },
                     error: function (jqxhr, status, errorThrown) {
                         var errstr = "Error: " + status + " " + errorThrown;
                         console.log(errstr);
                         alert(errstr);
                     },
                 });
             });
             var ta = $('#chat-type')[0];
             var chatbox = new Autogrow(ta);
             function chat_send (msg) {
                 var el = $("<div>").attr('class', 'chatMessage').
                 $('#chat-messages').
             }
             $('#chat-type').keydown(function (ev) {
                 if (ev.which == 13 && !ev.shiftKey) {
                     console.log("Enter key triggered");
                     return false;
                 }
                 return true;
             });
         });
        </script>
    {% endif %}
{% endblock %}
{% block content %}
    <h2>{{ chapter.story.title }}</h2>
    {% if chapter == chapter.story.chapters[0] %}
        <div class="description">
            {{ chapter.story.description | safe }}
        </div>
    {% endif %}
    {% for p in chapter.posts %}
        <div class="post">
            {{ p.text | safe }}
        </div>
    {% endfor %}
    {% if chapter.story.author == user %}
        <h5 class="mb-3">Post a new chapter</h5>
        <div id="quill-editor">
        </div>
        <button class="btn mt-2" id="post-button">Post</button>
    {% endif %}
{% endblock %}
{% block sidebar %}
    <div class="chat">
        <div id="chat-messages">
        </div>
        <div class="chat-controls form-inline mb-2">
            <textarea rows="1" id="chat-type" class="form-control-sm mr-1"></textarea>
        </div>
    </div>
{% endblock %}
